<!DOCTYPE html>
<html>
<head>
    <title>Ropa Inteligente - Ubicación OSM</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIINfBG9z7L07adHvPtPmXoXY1FD3EV8PlE="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n6a4yRD0PshR4X5dJ+Ngyc8K1k6iB73pXn3JbH0eA="
        crossorigin=""></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <style>
        /* La altura al 100% de la ventana es necesaria para que el mapa se vea */
        #map { height: 100vh; width: 100%; } 
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // 🚨 CONFIGURACIÓN MQTT (MISMA QUE EL CÓDIGO ANTERIOR)
        const MQTT_BROKER = "ed0fe265f224c2fd7b7e116929d24f3.s1.eu.hivemq.cloud"; 
        const MQTT_PORT = 8884; // Puerto Websocket Seguro
        const MQTT_USERNAME = "ropainteligente";
        const MQTT_PASSWORD = "Abc123**"; 
        const MQTT_TOPIC = "ropa/ubicacion/coordenadas"; 

        let map;
        let gpsMarker;
        let mqttClient;

        // ---------------------- 1. INICIALIZAR LEAFLET MAPS ----------------------
        function initMap() {
            const initialPos = [14.6349, -90.5069]; // [Lat, Lng]
            
            // Crea el mapa y lo centra en la posición inicial
            map = L.map('map').setView(initialPos, 15);

            // Añade la capa de mosaicos de OpenStreetMap (el mapa visual)
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Crea el marcador inicial
            gpsMarker = L.marker(initialPos).addTo(map)
                .bindPopup("Ubicación de Ropa Inteligente").openPopup();
            
            connectMQTT();
        }

        // ---------------------- 2. CONEXIÓN Y SUSCRIPCIÓN MQTT ----------------------
        function connectMQTT() {
            mqttClient = new Paho.MQTT.Client(
                MQTT_BROKER, 
                Number(MQTT_PORT), 
                "/mqtt", 
                "web_client_leaflet_" + parseInt(Math.random() * 1000, 10)
            );

            mqttClient.onMessageArrived = onMessageArrived;
            mqttClient.onConnectionLost = onConnectionLost;

            mqttClient.connect({ 
                userName: MQTT_USERNAME,
                password: MQTT_PASSWORD,
                useSSL: true, 
                onSuccess: onConnect, 
                onFailure: onFailure
            });
        }

        function onConnect() {
            console.log("Conectado y suscrito al broker MQTT");
            mqttClient.subscribe(MQTT_TOPIC);
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Conexión MQTT perdida:", responseObject.errorMessage);
                setTimeout(connectMQTT, 5000); 
            }
        }
        
        function onFailure(responseObject) {
            console.log("Fallo de conexión MQTT:", responseObject.errorMessage);
            setTimeout(connectMQTT, 5000); 
        }

        // ---------------------- 3. ACTUALIZAR EL MAPA LEAFLET ----------------------
        function onMessageArrived(message) {
            try {
                const payload = JSON.parse(message.payloadString);
                
                const newPos = [ 
                    parseFloat(payload.lat), 
                    parseFloat(payload.lng) 
                ];
                
                // Mover el marcador
                gpsMarker.setLatLng(newPos);
                
                // Centrar el mapa en la nueva ubicación
                map.setView(newPos, map.getZoom()); 
                console.log("Ubicación actualizada:", newPos);
                
            } catch (e) {
                console.error("Error al parsear o actualizar el mapa:", e);
            }
        }

        // Iniciar el mapa al cargar la página
        window.onload = initMap;
    </script>
</body>
</html>