<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ropa Inteligente - Ubicación en Tiempo Real (MQTT)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        /* La altura al 100% de la ventana es crucial */
        #map { height: 100vh; width: 100%; } 
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <script>
        // 🚨 CONFIGURACIÓN MQTT SEGURA (TUS DATOS)
        const MQTT_BROKER = "ed0fe265fc224c2f87f7e116929d24f3.s1.eu.hivemq.cloud"; 
        const MQTT_PORT = 8884; // Puerto Websocket Seguro
        const MQTT_USERNAME = "ropainteligente";
        const MQTT_PASSWORD = "Abc123**"; 
        const MQTT_TOPIC = "ropa/ubicacion/coordenadas"; 

        let map;
        let gpsMarker;
        let mqttClient;

        // ---------------------- 1. INICIALIZAR LEAFLET MAPS ----------------------
        function initMap() {
            const initialPos = [14.6349, -90.5069]; // Posición por defecto
            
            map = L.map('map').setView(initialPos, 15); 

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            gpsMarker = L.marker(initialPos).addTo(map)
                .bindPopup("Ubicación actual").openPopup();
            
            connectMQTT();
        }

        // ---------------------- 2. CONEXIÓN Y SUSCRIPCIÓN MQTT ----------------------
        function connectMQTT() {
            mqttClient = new Paho.MQTT.Client(
                MQTT_BROKER, 
                Number(MQTT_PORT), 
                "/mqtt", 
                "web_client_final_" + parseInt(Math.random() * 1000, 10)
            );

            mqttClient.onMessageArrived = onMessageArrived;
            mqttClient.onConnectionLost = onConnectionLost;

            mqttClient.connect({ 
                userName: MQTT_USERNAME,
                password: MQTT_PASSWORD,
                useSSL: true, 
                onSuccess: onConnect, 
                onFailure: onFailure
            });
        }

        function onConnect() {
            console.log("Conexión MQTT exitosa. Suscribiéndose al tópico:", MQTT_TOPIC);
            mqttClient.subscribe(MQTT_TOPIC);
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Conexión MQTT perdida, reintentando...");
                setTimeout(connectMQTT, 5000); 
            }
        }
        
        function onFailure(responseObject) {
            console.error("Fallo de conexión MQTT:", responseObject.errorMessage);
            setTimeout(connectMQTT, 5000); 
        }

        // ---------------------- 3. ACTUALIZAR EL MAPA LEAFLET ----------------------
        function onMessageArrived(message) {
            try {
                const payload = JSON.parse(message.payloadString);
                const newPos = [ parseFloat(payload.lat), parseFloat(payload.lng) ];
                
                gpsMarker.setLatLng(newPos);
                map.setView(newPos, map.getZoom()); 
                console.log("Ubicación GPS recibida y actualizada:", newPos);
                
            } catch (e) {
                console.error("Error al procesar el mensaje MQTT:", e);
            }
        }

        // Llamada a la función de inicialización del mapa
        initMap(); 
    </script>
</body>
</html>